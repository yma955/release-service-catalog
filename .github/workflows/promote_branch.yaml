---
name: Promote branch
on:
  workflow_dispatch:
    inputs:
      promotion-type:
        description: The type of promotion to perform
        type: choice
        required: true
        default: development-to-staging
        options:
          - development-to-staging
          - staging-to-production
      force-to-staging:
        description: |
          Force to staging: Allow promotion to staging even if staging and production differ
        type: boolean
        required: true
        default: false
      override:
        description: |
          Override: Allow promotion to production even if the change has not been in staging for one
          week
        type: boolean
        required: true
        default: false
      dry-run:
        description: |
          Dry run: Print out the changes that would be promoted but do not perform the git push
        type: boolean
        required: true
        default: false
      send-email-report:
        description: |
          Send email report: Generate and send AI-powered email report after promotion
        type: boolean
        required: true
        default: false
jobs:
  promote-branch:
    name: Promote Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
        with:
          fetch-depth: 0  # Fetch full history for commit analysis
      
      - name: Capture commits for report (if email report requested)
        if: inputs.send-email-report == true
        id: capture-commits
        run: |
          # Determine source and target branches
          if [ "${{ inputs.promotion-type }}" = "development-to-staging" ]; then
            FROM_BRANCH="development"
            TO_BRANCH="staging"
          else
            FROM_BRANCH="staging"
            TO_BRANCH="production"
          fi
          
          # Fetch latest remote state
          git fetch --no-tags origin
          
          # Get commit range and store in file for later use
          echo "FROM_BRANCH=$FROM_BRANCH" >> $GITHUB_ENV
          echo "TO_BRANCH=$TO_BRANCH" >> $GITHUB_ENV
          
          # Capture the commit range before promotion
          COMMIT_RANGE="origin/$TO_BRANCH..origin/$FROM_BRANCH"
          echo "COMMIT_RANGE=$COMMIT_RANGE" >> $GITHUB_ENV
          
          # Get commit hashes and store them
          COMMITS=$(git log --pretty=format:"%H" $COMMIT_RANGE | head -50)
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Store commits in a file for manual recovery
          echo "$COMMITS" > /tmp/promoted_commits.txt
          
          # Also capture the current HEAD of source branch for reference
          SOURCE_HEAD=$(git rev-parse origin/$FROM_BRANCH)
          echo "SOURCE_HEAD=$SOURCE_HEAD" >> $GITHUB_ENV
          
          echo "üìä Captured $(echo "$COMMITS" | wc -l) commits for report generation"
          echo "üìä Source branch HEAD: $SOURCE_HEAD"

      - name: Run branch promotion script
        id: promote
        run: |
          .github/scripts/promote_branch.sh --promotion-type $PROMOTION_TYPE --force-to-staging $FORCE \
            --override $OVERRIDE --dry-run $DRY
        env:
          PROMOTION_TYPE: ${{ inputs.promotion-type }}
          FORCE: ${{ inputs.force-to-staging }}
          OVERRIDE: ${{ inputs.override }}
          DRY: ${{ inputs.dry-run }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Set up Python
        if: |
          steps.promote.outcome == 'success' && 
          inputs.send-email-report == true
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: |
          steps.promote.outcome == 'success' && 
          inputs.send-email-report == true
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml markdown google-generativeai
      
      - name: Generate promotion report
        if: |
          steps.promote.outcome == 'success' && 
          inputs.send-email-report == true
        id: generate-report
        continue-on-error: true
        run: |
          # Create secret files securely
          echo "${{ secrets.GEMINI_API_KEY }}" > /tmp/gemini_api_key
          echo "${{ secrets.SMTP_USERNAME }}" > /tmp/smtp_username  
          echo "${{ secrets.SMTP_PASSWORD }}" > /tmp/smtp_password
          echo "${{ secrets.GH_TOKEN }}" > /tmp/gh_token
          chmod 600 /tmp/gemini_api_key /tmp/smtp_username /tmp/smtp_password /tmp/gh_token
          
          # Generate the promotion report using captured commit range
          python .github/scripts/generate_promotion_report.py $FROM_BRANCH $TO_BRANCH --commit-range "$COMMIT_RANGE"
          
          # Clean up secret files
          rm -f /tmp/gemini_api_key /tmp/smtp_username /tmp/smtp_password /tmp/gh_token
        env:
          # Non-sensitive configuration
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          # Sensitive secrets mounted as files per security team recommendation
          GEMINI_API_KEY_FILE: /tmp/gemini_api_key
          SMTP_USERNAME_FILE: /tmp/smtp_username
          SMTP_PASSWORD_FILE: /tmp/smtp_password
          GH_TOKEN_FILE: /tmp/gh_token
      
      - name: Report generation status
        if: always() && inputs.send-email-report == true
        run: |
          if [ "${{ steps.promote.outcome }}" = "success" ]; then
            if [ "${{ steps.generate-report.outcome }}" = "success" ]; then
              echo "‚úÖ Promotion and email report completed successfully"
            else
              echo "‚ö†Ô∏è WARNING: Promotion succeeded but email report generation failed"
              echo "üìß Report can be generated manually using commit range: $COMMIT_RANGE"
              echo "üìñ See documentation for manual report generation steps"
            fi
          else
            echo "‚ùå Promotion failed - no report generated"
          fi
