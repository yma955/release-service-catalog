---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-request-and-upload-signature-failure
  annotations:
    test/assert-task-failure: "run-task"
spec:
  description: |
    Run the request-and-upload-signature with error in signer response 
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup
      workspaces:
        - name: data
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: data
        steps:
          - name: setup-values
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            securityContext:
              runAsUser: 1001
            script: |
              #!/usr/bin/env bash
              set -eux
              cat << EOF | jq -Mc > "$(workspaces.data.path)/mocked_signing_response"
              {
                "signer_result": {"status": "error", "error_message": "test-error"},
                "operation_results": [
                  [
                    {"i": 1,
                     "msg": {
                       "errors": [],
                       "manifest_digest": "sha256:123456",
                       "pub_task_id": "123456",
                       "repo": "test-repo",
                       "request_id": "1",
                       "request_received_time": "3000-01-01T01:01:01.000000",
                       "requested_by": "test-user",
                       "sig_key_id": "test-signing-key",
                       "sig_keyname": "test-signing-key",
                       "signature_type": "container_signature",
                       "signed_claim": "signed-data",
                       "signing_server_requested": "3000-01-01T01:01:01.000000",
                       "signing_server_responded": "3000-01-01T01:01:02.000000",
                       "signing_status": "success"
                     },
                    "msg_id": "msg-id-1",
                    "timestamp": 1738685708,
                    "topic": "/topic/VirtualTopic.eng.test.dist.sign.123456",
                    "username": "1001030000"
                    },
                    {"amq6100_originalDestination": "topic://VirtualTopic.eng.test.dist.sign.123456",
                     "content-type": "text/plain",
                     "amq6100_destination": "queue://Consumer.test-user.123456.VirtualTopic.eng.test.dist.sign.123456"
                    }
                  ]
                ],
                "operation": {
                  "digests": ["sha256:123456"],
                  "references": ["registry.redhat.io/myproduct/myrepo:abc"],
                  "signing_key": "test-signing-key", "task_id": "123456"
                },
                "signing_key": "test-signing-key"
              }
              EOF
              touch "$(workspaces.data.path)/mock_pubtools-pyxis-upload-signatures.txt"
              touch "$(workspaces.data.path)/signing_response.json"
              cat "$(workspaces.data.path)/mocked_signing_response"
    - name: run-task
      taskRef:
        name: request-and-upload-signature
      params:
        - name: pipeline_image
          value: "quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b"
        - name: manifest_digests
          value: "sha256:0000"
        - name: references
          value: "registry.redhat.io/myproduct/myrepo:abc"
        - name: requester
          value: iamgoingtofail
        - value: containerisvsign
          name: sig_key_names
        - name: pyxis_ssl_cert_secret_name
          value: pyxis-ssl-cert
        - name: pyxis_ssl_cert_file_name
          value: cert
        - name: pyxis_ssl_key_file_name
          value: key
        - value: operatorpipelines
          name: umb_client_name
        - value: VirtualTopic.eng.robosignatory.isv.sign
          name: umb_listen_topic
        - value: VirtualTopic.eng.operatorpipelines.isv.sign
          name: umb_publish_topic
        - value: umb.api.redhat.com
          name: umb_url
        - name: umb_ssl_cert_secret_name
          value: umb-ssl-cert
        - name: umb_ssl_cert_file_name
          value: cert
        - name: umb_ssl_key_file_name
          value: key
        - value: https://pyxis.engineering.redhat.com
          name: pyxis_url
        - name: signature_data_file
          value: "signing_response.json"
      workspaces:
        - name: data
          workspace: tests-workspace
      runAfter:
        - setup
    - name: check-result
      workspaces:
        - name: data
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: data
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            securityContext:
              runAsUser: 1001
            script: |
              #!/usr/bin/env sh
              set -eux

              if [ "$(cat "$(workspaces.data.path)/request-signature-failure-count.txt")" != 3 ]; then
                echo Error: request-signature was expected to be fail 3 times. Actual calls:
                cat "$(workspaces.data.path)/request-signature-failure-count.txt"
                exit 1
              fi
      runAfter:
        - run-task
