---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-request-and-upload-signature-batch-signer
spec:
  description: |
    Run the request-and-upload-signature task with batch signer and multiple signing keys.
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup
      workspaces:
        - name: data
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: data
        steps:
          - name: setup-values
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux
              cat << EOF | jq -Mc > "$(workspaces.data.path)/mocked_signing_response"
              {
                "signer_result": {
                  "status": "ok",
                  "error_message": ""
                },
                "operation_results": [
                  [
                    {
                      "i": 1,
                      "msg": {
                        "claims": [
                          {
                            "claim_file": "eyJjcml0aWNhbCI6eyJpZGVudGl0eSI6eyJkb2NrZXItcmVmZXJlbmNlIjoicmVmMSJ9fX0K",
                            "manifest_digest": "digest1",
                            "signed_claims": {
                              "redhate2etesting": "signed1"
                            },
                            "repo": "repo1"
                          },
                          {
                            "claim_file": "eyJjcml0aWNhbCI6eyJpZGVudGl0eSI6eyJkb2NrZXItcmVmZXJlbmNlIjoicmVmMSJ9fX0K",
                            "manifest_digest": "digest2",
                            "signed_claims": {
                              "redhate2etesting": "signed2"
                            },
                            "repo": "repo1"
                          },
                          {
                            "claim_file": "eyJjcml0aWNhbCI6eyJpZGVudGl0eSI6eyJkb2NrZXItcmVmZXJlbmNlIjoicmVmMSJ9fX0K",
                            "manifest_digest": "digest3",
                            "signed_claims": {
                              "redhate2etesting": "signed3"
                            },
                            "repo": "repo1"
                          },
                          {
                            "claim_file": "eyJjcml0aWNhbCI6eyJpZGVudGl0eSI6eyJkb2NrZXItcmVmZXJlbmNlIjoicmVmMSJ9fX0K",
                            "manifest_digest": "digest4",
                            "signed_claims": {
                              "redhate2etesting": "signed4"
                            },
                            "repo": "repo1"
                          }
                        ],
                        "created": "2025-10-23T10:54:09.191275Z",
                        "errors": [],
                        "pub_task_id": "13",
                        "repo": "repo1",
                        "request_id": "f1a99acf-1372-483c-977a-fe89fdd14731",
                        "request_received_time": "2025-10-23T10:54:10.459475",
                        "requested_by": "hacbs-testing",
                        "signing_server_average_time_secs": 0.19742716666666668,
                        "signing_status": "success"
                      },
                      "msg_id": "2025-50bb9dcf-9d54-41f6-b19f-e418ed8bc615",
                      "timestamp": 1761216851,
                      "topic": "/topic/VirtualTopic.eng.robosignatory.konflux.sign.13",
                      "username": "1001030000"
                    },
                    {
                      "amq6100_originalDestination": "topic://VirtualTopic.eng.robosignatory.konflux.sign.13",
                      "content-type": "text/plain",
                      "amq6100_destination": "queue://Consumer.hacbs-testing.13.VirtualTopic.eng.robosignatory.konflux.sign.13"
                    }
                  ]
                ],
                "operation": {
                  "digests": [
                    "digest1",
                    "digest2",
                    "digest3",
                    "digest4"
                  ],
                  "references": [
                    "ref1",
                    "ref2",
                    "ref3",
                    "ref4"
                  ],
                  "signing_key_names": [
                    "containerisvsign",
                    "containerisvsign1"
                  ],
                  "signing_keys": [
                    "37036A73",
                    "37036A74"
                  ],
                  "task_id": "13",
                  "requester": null
                },
                "signing_keys": [
                  "37036A73",
                  "37036A74"
                ]
              }
              EOF
              touch "$(workspaces.data.path)/mock_pubtools-pyxis-upload-signatures.txt"
              touch "$(workspaces.data.path)/signing_response.json"
              cat "$(workspaces.data.path)/mocked_signing_response"
    - name: run-task
      taskRef:
        name: request-and-upload-signature
      params:
        - name: pipeline_image
          value: "quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b"
        - name: manifest_digests
          value: "sha256:0000 sha256:0001"
        - name: references
          value: "registry.redhat.io/myproduct/myrepo:abc registry.redhat.io/myproduct/myrepo:def"
        - name: requester
          value: tom
        - value: containerisvsign containerisvsign1
          name: sig_key_names
        - name: pyxis_ssl_cert_secret_name
          value: pyxis-ssl-cert
        - name: pyxis_ssl_cert_file_name
          value: cert
        - name: pyxis_ssl_key_file_name
          value: key
        - value: operatorpipelines
          name: umb_client_name
        - value: VirtualTopic.eng.robosignatory.isv.sign
          name: umb_listen_topic
        - value: VirtualTopic.eng.robosignatory.konflux.sign
          name: umb_batch_listen_topic
        - value: VirtualTopic.eng.operatorpipelines.isv.sign
          name: umb_publish_topic
        - value: VirtualTopic.eng.hacbs-signing-pipeline.konflux.sign
          name: umb_batch_publish_topic
        - value: umb.api.redhat.com
          name: umb_url
        - name: umb_ssl_cert_secret_name
          value: umb-ssl-cert
        - name: umb_ssl_cert_file_name
          value: cert
        - name: umb_ssl_key_file_name
          value: key
        - value: https://pyxis.engineering.redhat.com
          name: pyxis_url
        - name: signature_data_file
          value: "signing_response.json"
        - name: signer_type
          value: batch
      workspaces:
        - name: data
          workspace: tests-workspace
      runAfter:
        - setup
    - name: check-result
      workspaces:
        - name: data
          workspace: tests-workspace
      taskSpec:
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux
              umb_publish_topic=VirtualTopic.eng.operatorpipelines.isv.sign
              umb_batch_publish_topic=VirtualTopic.eng.hacbs-signing-pipeline.konflux.sign
              umb_listen_topic=VirtualTopic.eng.robosignatory.isv.sign
              umb_batch_listen_topic=VirtualTopic.eng.robosignatory.konflux.sign
              requester=tom
              umb_client_name=operatorpipelines

              cat <<EOF > "/tmp/expected_config.yaml"
              msg_signer:
                messaging_brokers:
                  - "amqps://umb.api.redhat.com:5671"
                messaging_cert_key: /tmp/umb.pem
                messaging_ca_cert: /etc/pki/tls/certs/ca-bundle.crt
                topic_send_to: topic://${umb_publish_topic}
                topic_listen_to: queue://Consumer.test-mock.${requester}-{task_id}.${umb_listen_topic}
                environment: prod
                service: ${umb_client_name}
                timeout: 60
                retries: 2
                send_retries: 2
                message_id_key: request_id
                log_level: debug
              msg_batch_signer:
                messaging_brokers:
                  - "amqps://umb.api.redhat.com:5671"
                messaging_cert_key: /tmp/umb.pem
                messaging_ca_cert: /etc/pki/tls/certs/ca-bundle.crt
                topic_send_to: topic://${umb_batch_publish_topic}
                topic_listen_to: queue://Consumer.test-mock.${requester}-{task_id}.${umb_batch_listen_topic}.{task_id}
                environment: prod
                service: ${umb_client_name}
                timeout: 60
                retries: 2
                send_retries: 2
                message_id_key: request_id
                log_level: debug
                chunk_size: 200
              EOF
              diff -Naur "/tmp/expected_config.yaml" "$(workspaces.data.path)/pubtools-sign-config.yaml"

              expected="--requester tom --signing-key containerisvsign --signing-key containerisvsign1 \
              --signing-key-name containerisvsign --signing-key-name containerisvsign1 \
              --config-file $(workspaces.data.path)/pubtools-sign-config.yaml \
              --reference registry.redhat.io/myproduct/myrepo:abc \
              --reference registry.redhat.io/myproduct/myrepo:def \
              --digest sha256:0000 --digest sha256:0001 --signer-type batch \
              --task-id 1234"
              echo "$expected" > "/tmp/expected"
              cat "$(workspaces.data.path)/mock_pubtools-sign.txt"
              diff -Naur "/tmp/expected" "$(workspaces.data.path)/mock_pubtools-sign.txt"
      runAfter:
        - run-task
