---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-get-advisory-severity
spec:
  description: |
    Run the get-advisory-severity task with a CVE that is critical. The task result
    should be CRITICAL
  tasks:
    - name: run-task
      taskRef:
        name: get-advisory-severity
      params:
        - name: releaseNotesImages
          value: >-
            H4sIAAAAAAAAA4uuVipKLcgvzizJL6pUslJKy89X0lFKLkstVrKqVkrLrEhNATGcw1x1k4sySzKTE3NA/OT83IL8vNS8EqCy6NhaHbCC3PyU1KLEklQsCoBAB82mpMQiGtkUywUA4JaextYAAAA=
          # value before before `gzip -c|base64 -w 0` encoding:
          # [{"repository":"foo","cves":{"fixed":{"CVE-critical":{"components":[]},
          # "CVE-moderate":{"components":[]}}}},{"repository":"bar","cves":{"fixed":{"CVE-critical":{"components":[]},"CVE-moderate":{"components":[]}}}}]
        - name: internalRequestPipelineRunName
          value: $(context.pipelineRun.name)
    - name: check-result
      runAfter:
        - run-task
      params:
        - name: result
          value: $(tasks.run-task.results.result)
        - name: severity
          value: $(tasks.run-task.results.severity)
      taskSpec:
        params:
          - name: result
            type: string
          - name: severity
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils@sha256:f10b4ad888634a7633f76ede29003ce1471aec2b76a7d9e01ad282a3011eb78f
            script: |
              #!/usr/bin/env bash
              set -eux

              if [ "$(params.result)" != Success ]; then
                echo Error: result task result is not correct
                exit 1
              fi

              if [ "$(params.severity)" != "Critical" ]; then
                echo Error: severity task result is not correct
                exit 1
              fi
