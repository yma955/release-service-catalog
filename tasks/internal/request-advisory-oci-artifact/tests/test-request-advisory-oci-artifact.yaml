---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-create-advisory-oci-artifact-task
spec:
  description: |
    Run the create-advisory-oci-artifact-task task and check that an oci artifact is generated
  tasks:
    - name: run-task
      taskRef:
        name: request-advisory-oci-artifact
      params:
        - name: advisory_url
          value: https://some-url.com/advisory.yaml
        - name: pipelineRunUid
          value: $(context.pipelineRun.uid)
        - name: taskGitUrl
          value: "http://localhost"
        - name: taskGitRevision
          value: "main"
    - name: check-result
      runAfter:
        - run-task
      params:
        - name: advisory_oci_artifact
          value: $(tasks.run-task.results.advisory-oci-artifact)
      taskSpec:
        params:
          - name: advisory_oci_artifact
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux

              echo Test that advisory_url was properly set
              test -n "$(params.advisory_oci_artifact)"
  finally:
    - name: cleanup
      taskSpec:
        steps:
          - name: delete-crs
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux

              kubectl delete internalrequests --all
