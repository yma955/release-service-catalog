---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-filter-already-released-advisory-images
spec:
  description: |
    Test the filter-already-released-advisory-images-task by providing a snapshot with
    both released and new images. The released component should be filtered out (matches advisory),
    leaving only the new component.
  tasks:
    - name: run-filter-task
      taskRef:
        name: filter-already-released-advisory-images-task
      params:
        - name: transformedSnapshot
          # Transformed snapshot with arch-specific images before `gzip -c|base64 -w 0` encoding:
          # '[{"name":"released-component","containerImage":"registry.redhat.io/test@sha256:releasedarch123","tags":["v1.0"],"repository":"registry.redhat.io/test","rh-registry-repo":"registry.redhat.io/test","originalComponent":"released-component","architecture":"amd64"},{"name":"new-component","containerImage":"registry.redhat.io/test@sha256:newarch456","tags":["v1.0"],"repository":"registry.redhat.io/test","rh-registry-repo":"registry.redhat.io/test","originalComponent":"new-component","architecture":"amd64"}]'
          value: 'H4sICAA5o2gAA2NvcnJlY3RfZGF0YS5qc29uAMWQsQ6CQAyGdx+jM6AgMDCZOPkMhKE5muMSuDO9qiHGd5eLgcGIi4Nz//9rv9Z3sDgQVMDUE3pqY+WGs7NkBSJQzgoaS3waUL9S2njhMWFqO5TEuK2Ql4PvMCvKaoYgqy7N9hNBUHuoarimyQ6aaAKcnTfieFynTTXu4nkYh8rXsGOjjcX+uFy+ohPOMkJKLhxkcGjLHB7R8gNLt5/0p35YkRflH83fJT5LN5snGb4uPvsBAAA='
        - name: origin
          value: "test-origin"
        - name: advisory_secret_name
          value: "filter-already-released-advisory-images-secret"
        - name: internalRequestPipelineRunName
          value: "$(context.pipelineRun.name)"
    - name: validate-result
      runAfter:
        - run-filter-task
      params:
        - name: result
          value: "$(tasks.run-filter-task.results.result)"
        - name: unreleased_components
          value: "$(tasks.run-filter-task.results.unreleased_components)"
      taskSpec:
        params:
          - name: result
            type: string
          - name: unreleased_components
            type: string
        steps:
          - name: validate
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux

              echo "Validating filter task result..."

              if [[ "$(params.result)" != "Success" ]]; then
                echo "Task result was not Success: $(params.result)"
                exit 1
              fi

              # Verify unreleased components list
              UNRELEASED_COMPONENTS=$(base64 -d <<< "$(params.unreleased_components)" | gunzip)
              UNRELEASED_COUNT=$(jq 'length' <<< "$UNRELEASED_COMPONENTS")
              if [[ "$UNRELEASED_COUNT" -ne 1 ]]; then
                echo "Expected 1 unreleased component, but found $UNRELEASED_COUNT"
                exit 1
              fi

              UNRELEASED_NAME=$(jq -r '.[0]' <<< "$UNRELEASED_COMPONENTS")
              if [[ "$UNRELEASED_NAME" != "new-component" ]]; then
                echo "Unexpected unreleased component name: $UNRELEASED_NAME"
                exit 1
              fi

              echo "Validation successful!"
