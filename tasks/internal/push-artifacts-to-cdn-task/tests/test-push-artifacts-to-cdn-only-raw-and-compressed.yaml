---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-push-artifacts-to-cdn-only-raw-and-compressed
spec:
  description: |
    Run the push-artifacts task and only push to CDN since the CGW config data is not present
    in the snapshot, and will publish the "raw" and "compressed" files.
  tasks:
    - name: run-task
      taskRef:
        name: push-artifacts-to-cdn-task
      params:
        - name: snapshot_json
          value: >-
            {
              "application": "amd-bootc-1-3-qcow2-disk-image",
              "artifacts": {},
              "components": [
                {
                  "containerImage": "quay.io/org/tenant/qcow-disk-image/qcow2-disk-image@sha256:abcdef12345",
                  "contentGateway": {
                    "filePrefix": "testproduct-",
                    "productCode": "Code",
                    "productName": "MyName",
                    "productVersionName": "1.3-staging"
                  },
                  "files": [
                    {
                      "filename": "testproduct-binary-windows-amd64.zip",
                      "source": "testproduct-binary-windows-amd64.zip",
                      "delivery_format": ["raw", "compressed"]
                    },
                    {
                      "filename": "testproduct-binary-darwin-amd64.tar.gz",
                      "source": "testproduct-binary-darwin-amd64.tar.gz",
                      "delivery_format": ["raw", "compressed"]
                    },
                    {
                      "filename": "testproduct-binary-linux-amd64.tar.gz",
                      "source": "testproduct-binary-linux-amd64.tar.gz",
                      "delivery_format": ["raw", "compressed"]
                    }
                  ],
                  "name": "testproduct"
                }
              ]
            }
        - name: exodusGwSecret
          value: "pulp-task-exodus-secret"
        - name: exodusGwEnv
          value: "pre"
        - name: pulpSecret
          value: "pulp-task-pulp-secret"
        - name: udcacheSecret
          value: "pulp-task-udc-secret"
        - name: cgwHostname
          value: "https://content-gateway.com"
        - name: cgwSecret
          value: "pulp-task-cgw-secret"
        - name: author
          value: testuser
        - name: signingKeyName
          value: testkey
    - name: check-result
      runAfter:
        - run-task
      params:
        - name: result
          value: $(tasks.run-task.results.result)
        - name: publishedFiles
          value: $(tasks.run-task.results.publishedFiles)
      taskSpec:
        params:
          - name: result
            type: string
          - name: publishedFiles
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:91c030b48f7f1f88b32fba336fa5c2725a0f0bfd
            script: |
              #!/usr/bin/env bash
              set -ex
              # this grep uses extented regex mode (-E) to check if the files listed in the publishedFiles
              # result, end with .zip or .gz, and files that do not end with .zip and .gz as the
              # push-artifacts-to-cdn-task task should upload both raw and compressed files to
              # the Content Gateway.
              ( grep -vE '.*\.(zip|gz)$' <<< "$(params.publishedFiles)" && \
                grep -E '.*\.(zip|gz)$' ) <<< "$(params.publishedFiles)" \
                || ( echo "Error: the task should publish both raw and compressed files to CGW" && exit 1 )
              if [[ "$(params.result)" != "Success" ]]; then
                echo Error: result task result expected to be Success but was not
                exit 1
              fi
