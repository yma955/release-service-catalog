---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-update-fbc-catalog-hotfix
spec:
  description: |
    Tests the pipeline behavior with hotfix-style parameters.
    This test validates the expected behavior for hotfix builds:
    no overwrite, but signing and publishing enabled.
  tasks:
    - name: run-task
      taskRef:
        name: update-fbc-catalog-task
      params:
        - name: fbcFragments
          value: '["registry.io/image0@sha256:0000"]'
        - name: fromIndex
          value: "quay.io/scoheb/fbc-index-testing:latest"
        - name: buildTags
          value: '["v4.12", "hotfix"]'
        - name: addArches
          value: "[]"
        - name: iibServiceAccountSecret
          value: "iib-service-account-secret"
        - name: publishingCredentials
          value: "publishing-credentials"
        - name: mustOverwriteFromIndexImage
          value: "false"  # Hotfix: no overwrite
        - name: mustPublishIndexImage
          value: "true"   # Hotfix: publish enabled
    - name: check-result
      params:
        - name: jsonBuildInfo
          value: $(tasks.run-task.results.jsonBuildInfo)
        - name: buildState
          value: $(tasks.run-task.results.buildState)
        - name: iibLog
          value: $(tasks.run-task.results.iibLog)
        - name: exitCode
          value: $(tasks.run-task.results.exitCode)
      taskSpec:
        params:
          - name: jsonBuildInfo
            type: string
          - name: buildState
            type: string
          - name: iibLog
            type: string
          - name: exitCode
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:82012e03002128f2a226acb23dc5c6fc1c37f5b6
            env:
              - name: BUILD_STATE
                value: $(params.buildState)
              - name: JSON_BUILDINFO
                value: $(params.jsonBuildInfo)
            script: |
              #!/bin/bash
              set -x

              # Verify the task completed successfully
              state="$(jq -cr .state <<< "${BUILD_STATE}")"
              if [ "$state" != "complete" ]; then
                echo "The task did not save a completed IIB build in buildState result"
                exit 1
              fi
              if [ "$(params.exitCode)" != "0" ]; then
                echo "The task did not finish with a successful exit code"
                exit 1
              fi

              # Verify buildTags were parsed correctly (tests bug fixes)
              buildInfo=$(base64 -d <<< "${JSON_BUILDINFO}" | gunzip)
              buildTags=$(jq -r '.build_tags' <<< "${buildInfo}")
              if [ "$buildTags" = "null" ] || [ -z "$buildTags" ]; then
                echo "ERROR: build_tags missing from build info - buildTags parameter not processed correctly"
                exit 1
              fi

              # Verify the tags match what we passed in
              expectedTags='["hotfix","v4.12"]'  # sorted alphabetically by IIB
              actualTags=$(jq -c '.build_tags | sort' <<< "${buildInfo}")
              if [ "$actualTags" != "$expectedTags" ]; then
                echo "ERROR: build_tags mismatch. Expected: $expectedTags, Got: $actualTags"
                exit 1
              fi

              echo "SUCCESS: Hotfix behavior correctly set and buildTags validated"
      runAfter:
        - run-task
