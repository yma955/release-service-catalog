---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-update-fbc-catalog-staged-index
spec:
  description: |
    Tests the pipeline behavior with staged index-style parameters.
    This test validates the expected behavior for staged index builds:
    no overwrite, no signing, no publishing.
  tasks:
    - name: run-task
      taskRef:
        name: update-fbc-catalog-task
      params:
        - name: fbcFragments
          value: '["registry.io/image0@sha256:0000"]'
        - name: fromIndex
          value: "quay.io/scoheb/fbc-index-testing:latest"
        - name: buildTags
          value: "[]"
        - name: addArches
          value: "[]"
        - name: iibServiceAccountSecret
          value: "iib-service-account-secret"
        - name: publishingCredentials
          value: "publishing-credentials"
        - name: mustOverwriteFromIndexImage
          value: "false"  # Staged: no overwrite
        - name: mustPublishIndexImage
          value: "false"  # Staged: no publishing
    - name: check-result
      params:
        - name: jsonBuildInfo
          value: $(tasks.run-task.results.jsonBuildInfo)
        - name: buildState
          value: $(tasks.run-task.results.buildState)
        - name: indexImageDigests
          value: $(tasks.run-task.results.indexImageDigests)
        - name: iibLog
          value: $(tasks.run-task.results.iibLog)
        - name: exitCode
          value: $(tasks.run-task.results.exitCode)
      taskSpec:
        params:
          - name: jsonBuildInfo
            type: string
          - name: buildState
            type: string
          - name: indexImageDigests
            type: string
          - name: iibLog
            type: string
          - name: exitCode
            type: string
        steps:
          - name: check-result
            image: quay.io/konflux-ci/release-service-utils:82012e03002128f2a226acb23dc5c6fc1c37f5b6
            env:
              - name: BUILD_STATE
                value: $(params.buildState)
              - name: JSON_BUILDINFO
                value: $(params.jsonBuildInfo)
            script: |
              #!/bin/bash
              set -x

              # Verify the task completed successfully
              state="$(jq -cr .state <<< "${BUILD_STATE}")"
              if [ "$state" != "complete" ]; then
                echo "The task did not save a completed IIB build in buildState result"
                exit 1
              fi
              if [ "$(params.exitCode)" != "0" ]; then
                echo "The task did not finish with a successful exit code"
                exit 1
              fi

              echo "SUCCESS: StagedIndex behavior correctly set"
      runAfter:
        - run-task