---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-update-fbc-catalog-empty-fragments-array
  annotations:
    test/assert-task-failure: "run-task"
spec:
  description: Tests that the internal task properly fails when given empty fbcFragments array.
    This test validates that the task fails immediately when given an empty fragments array,
    as this represents invalid input that should be handled by the calling managed task.
  finally:
    - name: check-pipeline-failed
      taskSpec:
        steps:
          - name: verify-failure
            image: quay.io/konflux-ci/release-service-utils@sha256:f10b4ad888634a7633f76ede29003ce1471aec2b76a7d9e01ad282a3011eb78f
            script: |
              #!/bin/bash
              set -x

              # This test expects the pipeline to fail due to invalid empty fragments array
              # The internal task should fail fast with proper validation
              echo "Pipeline correctly failed due to empty fragments array validation"

              # If we reach this point, it means the pipeline is in finally block
              # which confirms the main task failed as expected
  tasks:
    - name: run-task
      taskRef:
        name: update-fbc-catalog-task
      params:
        - name: fbcFragments
          value: '[]'  # Empty JSON array - should cause immediate failure
        - name: fromIndex
          value: "quay.io/scoheb/fbc-index-testing:latest"
        - name: buildTags
          value: "[]"
        - name: addArches
          value: "[]"
        - name: iibServiceAccountSecret
          value: "iib-service-account-secret"
        - name: publishingCredentials
          value: "publishing-credentials"
