---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-push-oot-kmods-to-git
spec:
  description: Simplified test for Git push task - validates parameter parsing only.
  params:
    - name: dataDir
      description: The location where data will be stored
      type: string
      default: "/var/workdir/release"
    - name: taskGitUrl
      type: string
      default: "https://github.com/konflux-ci/release-service-catalog.git"
    - name: taskGitRevision
      type: string
      default: "main"
  tasks:
    - name: setup-and-validate
      taskSpec:
        params:
          - name: dataDir
            type: string
        steps:
          - name: setup-and-validate
            image: quay.io/konflux-ci/release-service-utils@sha256:454e457cdadd5892b31fe2b7d4911b3d3a761f5705bb0cd30f864be0a597594b
            script: |
              #!/usr/bin/env bash
              set -eux

              # Create single architecture structure
              mkdir -p "$(params.dataDir)"
              SIGNED_KMODS_PATH="$(params.dataDir)/signed-kmods"
              mkdir -p "$SIGNED_KMODS_PATH"

              # Create test .ko files
              echo "SIGNED_MODULE1_CONTENT" > "$SIGNED_KMODS_PATH/mod1.ko"
              echo "SIGNED_MODULE2_CONTENT" > "$SIGNED_KMODS_PATH/mod2.ko"

              # Create envfile with required variables
              cat > "$SIGNED_KMODS_PATH/envfile" << 'EOF'
              DRIVER_VERSION=1.0.0
              DRIVER_VENDOR=test-vendor
              KERNEL_VERSION=6.5.0-test
              EOF

              # Create checksums file
              cd "$SIGNED_KMODS_PATH" && sha256sum ./*.ko > signed_kmods_checksums.txt && cd -

              echo "Git test setup completed successfully"

              # Validate single architecture structure
              [ -f "$SIGNED_KMODS_PATH/mod1.ko" ] || { echo "ERROR: mod1.ko missing"; exit 1; }
              [ -f "$SIGNED_KMODS_PATH/mod2.ko" ] || { echo "ERROR: mod2.ko missing"; exit 1; }
              [ -f "$SIGNED_KMODS_PATH/envfile" ] || { echo "ERROR: envfile missing"; exit 1; }
              [ -f "$SIGNED_KMODS_PATH/signed_kmods_checksums.txt" ] || { echo "ERROR: checksums missing"; exit 1; }

              # Parse envfile content explicitly
              DRIVER_VENDOR=$(grep "^DRIVER_VENDOR=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)
              DRIVER_VERSION=$(grep "^DRIVER_VERSION=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)
              KERNEL_VERSION=$(grep "^KERNEL_VERSION=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)

              [ -n "$DRIVER_VENDOR" ] || { echo "ERROR: DRIVER_VENDOR not set"; exit 1; }
              [ -n "$DRIVER_VERSION" ] || { echo "ERROR: DRIVER_VERSION not set"; exit 1; }
              [ -n "$KERNEL_VERSION" ] || { echo "ERROR: KERNEL_VERSION not set"; exit 1; }

              # Verify checksums work
              cd "$SIGNED_KMODS_PATH" && sha256sum -c signed_kmods_checksums.txt && cd -

              echo "SUCCESS: All validation checks passed"
              echo "Task would push to Git repository: $DRIVER_VENDOR/$DRIVER_VERSION/$KERNEL_VERSION/"
      params:
        - name: dataDir
          value: $(params.dataDir)