---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-oot-kmods-to-git
spec:
  description: >-
    Task to upload out-of-tree kernel modules and optionally RPMs to a private vendor git repo
  params:
    - name: signedKmodsPath
      type: string
      description: Path where the kernel modules are stored relative to the dataDir
    - name: rpmPath
      type: string
      description: Path where the RPM packages are stored relative to the dataDir (optional)
      default: ""
    - name: dataDir
      type: string
      description: The absolute path to the working directory
      default: /var/workdir/release
    - name: gitRepoUrl
      type: string
      description: Repository URL where the artifacts will be pushed
    - name: gitBranch
      type: string
      description: Specific branch in the repository
    - name: gitTokenSecret
      type: string
      description: The name of the Kubernetes secret containing the Git token
    - name: sourceDataArtifact
      type: string
      description: OCI reference to the trusted artifact containing the dataDir contents
    - name: orasOptions
      description: oras options to pass to Trusted Artifacts calls
      type: string
      default: ""
    - name: trustedArtifactsDebug
      description: Flag to enable debug logging in trusted artifacts. Set to a non-empty string to enable
      type: string
      default: ""
    - name: taskGitUrl
      type: string
      description: The git repository URL for StepAction resolution
      default: https://github.com/konflux-ci/release-service-catalog.git
    - name: taskGitRevision
      type: string
      description: The git revision for StepAction resolution
      default: main
  volumes:
    - name: workdir
      emptyDir: {}
    - name: git-token-secret-vol
      secret:
        secretName: $(params.gitTokenSecret)
  stepTemplate:
    securityContext:
      runAsUser: 1001
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir
    env:
      - name: "ORAS_OPTIONS"
        value: "$(params.orasOptions)"
      - name: "DEBUG"
        value: "$(params.trustedArtifactsDebug)"
  steps:
    - name: use-trusted-artifact
      computeResources:
        limits:
          memory: 256Mi
        requests:
          memory: 256Mi
          cpu: 100m
      ref:
        resolver: "git"
        params:
          - name: url
            value: $(params.taskGitUrl)
          - name: revision
            value: $(params.taskGitRevision)
          - name: pathInRepo
            value: stepactions/use-trusted-artifact/use-trusted-artifact.yaml
      params:
        - name: workDir
          value: $(params.dataDir)
        - name: sourceDataArtifact
          value: $(params.sourceDataArtifact)
    - name: push-to-git
      image: quay.io/konflux-ci/release-service-utils:0f82be4be43294b6a96846d87ef7f7c0b9e34267
      computeResources:
        limits:
          memory: 1Gi
        requests:
          memory: 1Gi
          cpu: 250m
      volumeMounts:
        - name: git-token-secret-vol
          mountPath: /var/secrets/git-token
          readOnly: true
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail

        PUSH_TOKEN=$(cat /var/secrets/git-token/gitlab-gr-maintenance-token)
        SIGNED_KMODS_PATH="$(params.dataDir)/$(params.signedKmodsPath)"
        RPM_FULL_PATH="$(params.dataDir)/$(params.rpmPath)"
        REPO_URL="$(params.gitRepoUrl)"
        GIT_WORK_DIR="$(params.dataDir)/git-work"

        mkdir -p "${SIGNED_KMODS_PATH}"
        mkdir -p "${GIT_WORK_DIR}"
        cd "${GIT_WORK_DIR}"

        # Check if this is a multi-architecture build
        if [ -f "$(params.dataDir)/arch_count.txt" ]; then
            arch_count=$(cat "$(params.dataDir)/arch_count.txt")
            echo "Processing $arch_count architecture(s) for Git upload"
        else
            echo "No architecture information found, assuming single architecture"
            arch_count=1
        fi

        export GIT_LFS_SKIP_SMUDGE=1
        set +x # disable logging of the token
        PUSH_TOKEN_CLEAN=$(printf "%s" "$PUSH_TOKEN" | tr -d '\n')
        GIT_URL_WITH_AUTH="https://gitlab-ci-token:${PUSH_TOKEN_CLEAN}@${REPO_URL}"
        git clone --depth=1 --filter=blob:none --no-checkout \
          --single-branch --branch "$(params.gitBranch)" \
          "$GIT_URL_WITH_AUTH" local-artifacts
        set -x # enable logging after the token is added to the URL

        cd local-artifacts
        git sparse-checkout init --cone
        git config user.email "partner-accelerators@konflux-ci.redhat.com"
        git config user.name "Partner Accelerators CI Bot"

        # Function to push artifacts for a specific architecture
        push_arch_artifacts() {
            local arch_name="$1"
            local source_dir="$2"
            local arch_suffix=""

            # Add architecture suffix for multi-arch builds
            if [ "$arch_count" -gt 1 ]; then
                arch_suffix="_${arch_name}"
            fi

            echo "Processing artifacts for architecture: $arch_name"

            # Read envfile to get version information
            if [ -f "$source_dir/envfile" ]; then
                # shellcheck source=/dev/null
                . "$source_dir/envfile"
            else
                echo "ERROR: envfile not found in $source_dir"
                return 1
            fi

            TARGET_DIR="${DRIVER_VENDOR}_${DRIVER_VERSION}_${KERNEL_VERSION}${arch_suffix}"
            echo "Target directory for $arch_name: $TARGET_DIR"

            git sparse-checkout add "$TARGET_DIR"
            git checkout
            mkdir -p "$TARGET_DIR"

            # Copy .ko files
            if ls "$source_dir"/*.ko 1> /dev/null 2>&1; then
                cp "$source_dir"/*.ko "$TARGET_DIR/"
                echo "Copied .ko files for $arch_name"
            else
                echo "WARNING: No .ko files found for $arch_name"
                return 1
            fi

            # Copy architecture-specific checksum file
            if [ "$arch_count" -gt 1 ]; then
                if [ -f "$source_dir/signed_kmods_checksums_${arch_name}.txt" ]; then
                    cp "$source_dir/signed_kmods_checksums_${arch_name}.txt" "$TARGET_DIR/"
                    echo "Copied architecture-specific checksums for $arch_name"
                fi
            else
                if [ -f "$source_dir/signed_kmods_checksums.txt" ]; then
                    cp "$source_dir/signed_kmods_checksums.txt" "$TARGET_DIR/"
                    echo "Copied checksums for single architecture"
                fi
            fi

            # Copy envfile for reference
            if [ -f "$source_dir/envfile" ]; then
                cp "$source_dir/envfile" "$TARGET_DIR/"
                echo "Copied envfile for $arch_name"
            fi

            # Copy RPM files if available (architecture-specific RPMs would be in arch-specific directories)
            if [ -n "$(params.rpmPath)" ] && [ -d "${RPM_FULL_PATH}" ]; then
                # Look for architecture-specific RPMs or general RPMs
                rpm_source_dir="${RPM_FULL_PATH}"
                if [ "$arch_count" -gt 1 ] && [ -d "${RPM_FULL_PATH}/${arch_name}" ]; then
                    rpm_source_dir="${RPM_FULL_PATH}/${arch_name}"
                fi

                if [ -n "$(find "${rpm_source_dir}" -maxdepth 1 -name '*.rpm' -print -quit 2>/dev/null)" ]; then
                    cp "${rpm_source_dir}"/*.rpm "$TARGET_DIR/"
                    echo "Copied RPM files for $arch_name"
                fi
            fi

            # Add files to git
            git add "$TARGET_DIR"

            return 0
        }

        # Process architectures
        if [ "$arch_count" -gt 1 ]; then
            echo "Multi-architecture build detected, processing each architecture"

            # Verify we have the signing summary
            if [ -f "${SIGNED_KMODS_PATH}/signing_summary.txt" ]; then
                echo "Signing summary found:"
                cat "${SIGNED_KMODS_PATH}/signing_summary.txt"
            fi

            # Process each architecture directory
            for arch_dir in "${SIGNED_KMODS_PATH}"/*/; do
                if [ -d "$arch_dir" ]; then
                    arch_name=$(basename "$arch_dir")
                    echo "Processing Git upload for architecture: $arch_name"

                    if push_arch_artifacts "$arch_name" "$arch_dir"; then
                        echo "Successfully processed $arch_name"
                    else
                        echo "ERROR: Failed to process $arch_name"
                        exit 1
                    fi
                fi
            done

            # Create multi-arch summary file in the repository
            if [ -f "${SIGNED_KMODS_PATH}/signing_summary.txt" ]; then
                summary_target_dir="multi-arch-summary_$(date +%Y%m%d_%H%M%S)"
                git sparse-checkout add "$summary_target_dir"
                mkdir -p "$summary_target_dir"
                cp "${SIGNED_KMODS_PATH}/signing_summary.txt" "$summary_target_dir/"
                cp "${SIGNED_KMODS_PATH}/extraction_summary.txt" "$summary_target_dir/" 2>/dev/null || true
                git add "$summary_target_dir"
            fi

        else
            echo "Single architecture build, using standard upload"

            cd "${SIGNED_KMODS_PATH}"
            # Validate checksum file exists for single-arch
            if [ ! -f "signed_kmods_checksums.txt" ]; then
                echo "ERROR: signed_kmods_checksums.txt not found for single architecture build"
                exit 1
            fi

            # Verify checksums
            sha256sum -c signed_kmods_checksums.txt
            cd "${GIT_WORK_DIR}/local-artifacts"

            if push_arch_artifacts "single" "${SIGNED_KMODS_PATH}"; then
                echo "Successfully processed single architecture"
            else
                echo "ERROR: Failed to process single architecture"
                exit 1
            fi
        fi

        # Commit and push all changes
        if git status --porcelain | grep -q '^[ AM]'; then
            commit_message="Automated push from Build and Sign pipeline"
            if [ "$arch_count" -gt 1 ]; then
                commit_message="$commit_message (multi-arch: $arch_count architectures)"
            fi

            git commit -m "$commit_message"
            git push -u origin "$(params.gitBranch)"
            echo "Successfully pushed artifacts for $arch_count architecture(s) to Git"
        else
            echo "No changes to commit"
        fi
