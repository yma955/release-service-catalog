---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-oot-kmods-rpms
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: release
spec:
  description: >-
    Task to build RPM packages containing signed out-of-tree kernel modules
  params:
    - name: signedKmodsPath
      type: string
      description: Path where the signed kernel modules are stored in the workspace
    - name: rpmOutputPath
      type: string
      description: Path where the built RPM packages will be stored
      default: "rpms"
    - name: ociStorage
      description: The OCI repository where the Trusted Artifacts are stored
      type: string
      default: "empty"
    - name: ociArtifactExpiresAfter
      description: Expiration date for the trusted artifacts created in the
        OCI repository. An empty string means the artifacts do not expire
      type: string
      default: "1d"
    - name: trustedArtifactsDebug
      description: Flag to enable debug logging in trusted artifacts. Set to a non-empty string to enable
      type: string
      default: ""
    - name: orasOptions
      description: oras options to pass to Trusted Artifacts calls
      type: string
      default: ""
    - name: sourceDataArtifact
      type: string
      description: Location of trusted artifacts to be used to populate data directory
      default: ""
    - name: dataDir
      description: The location where data will be stored
      type: string
      default: /var/workdir/release
    - name: taskGitUrl
      type: string
      description: The git repository URL for task and StepAction resolution
      default: https://github.com/konflux-ci/release-service-catalog.git
    - name: taskGitRevision
      type: string
      description: The git revision for task and StepAction resolution
      default: main
    - name: caTrustConfigMapName
      type: string
      description: The name of the ConfigMap to read CA bundle data from
      default: trusted-ca
    - name: caTrustConfigMapKey
      type: string
      description: The name of the key in the ConfigMap that contains the CA bundle data
      default: ca-bundle.crt
  results:
    - name: sourceDataArtifact
      type: string
      description: Produced trusted data artifact
  volumes:
    - name: workdir
      emptyDir: {}
    - name: trusted-ca
      configMap:
        name: $(params.caTrustConfigMapName)
        items:
          - key: $(params.caTrustConfigMapKey)
            path: ca-bundle.crt
        optional: true
  stepTemplate:
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir
      - name: trusted-ca
        mountPath: /mnt/trusted-ca
        readOnly: true
    env:
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.ociArtifactExpiresAfter)
      - name: "ORAS_OPTIONS"
        value: "$(params.orasOptions)"
      - name: "DEBUG"
        value: "$(params.trustedArtifactsDebug)"
    securityContext:
      runAsUser: 1001
  steps:
    - name: use-trusted-artifact
      computeResources:
        limits:
          memory: 64Mi
        requests:
          memory: 64Mi
          cpu: 30m
      ref:
        resolver: "git"
        params:
          - name: url
            value: $(params.taskGitUrl)
          - name: revision
            value: $(params.taskGitRevision)
          - name: pathInRepo
            value: stepactions/use-trusted-artifact/use-trusted-artifact.yaml
      params:
        - name: workDir
          value: $(params.dataDir)
        - name: sourceDataArtifact
          value: $(params.sourceDataArtifact)
    - name: build-rpm-packages
      image: quay.io/konflux-ci/release-service-utils:02a8ddcd16113371a255fd1ef0a196399d300162
      computeResources:
        limits:
          memory: 512Mi
        requests:
          memory: 512Mi
          cpu: 250m
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail

        SIGNED_KMODS_PATH="$(params.dataDir)/$(params.signedKmodsPath)"
        RPM_OUTPUT_PATH="$(params.dataDir)/$(params.rpmOutputPath)"

        echo "Building RPM packages from signed modules in: ${SIGNED_KMODS_PATH}"
        echo "RPM output path: ${RPM_OUTPUT_PATH}"

        # Create RPM output directory
        mkdir -p "${RPM_OUTPUT_PATH}"

        # Work from a temporary directory to avoid corrupting signed kmods location
        TEMP_WORK_DIR="${RPM_OUTPUT_PATH}/temp_build"
        mkdir -p "${TEMP_WORK_DIR}"
        cd "${TEMP_WORK_DIR}"

        # Validate required files exist before copying
        if [ ! -f "${SIGNED_KMODS_PATH}/envfile" ]; then
            echo "ERROR: envfile not found in ${SIGNED_KMODS_PATH}"
            exit 1
        fi

        if ! ls "${SIGNED_KMODS_PATH}"/*.ko >/dev/null 2>&1; then
            echo "ERROR: No .ko files found in ${SIGNED_KMODS_PATH}"
            exit 1
        fi

        # Verify checksums to ensure .ko file integrity
        if [ ! -f "${SIGNED_KMODS_PATH}/signed_kmods_checksums.txt" ]; then
            echo "ERROR: signed_kmods_checksums.txt not found in ${SIGNED_KMODS_PATH}"
            echo "This file should be generated by the sign-oot-kmods task"
            exit 1
        fi

        echo "Verifying .ko file checksums before RPM build..."
        cd "${SIGNED_KMODS_PATH}"
        if ! sha256sum -c signed_kmods_checksums.txt; then
            echo "ERROR: Checksum verification failed for .ko files"
            echo "The .ko files have been modified since signing"
            exit 1
        fi
        echo "Checksum verification passed - .ko files are intact"
        cd "${TEMP_WORK_DIR}"

        # Copy signed kmods, envfile, and checksums to working directory
        cp "${SIGNED_KMODS_PATH}"/*.ko .
        cp "${SIGNED_KMODS_PATH}/envfile" .
        cp "${SIGNED_KMODS_PATH}/signed_kmods_checksums.txt" .

        # shellcheck source=/dev/null
        . ./envfile

        # Validate required environment variables
        if [ -z "${DRIVER_VENDOR:-}" ] || [ -z "${DRIVER_VERSION:-}" ] || [ -z "${KERNEL_VERSION:-}" ]; then
            echo "ERROR: Missing required environment variables from envfile"
            echo "Required: DRIVER_VENDOR, DRIVER_VERSION, KERNEL_VERSION"
            exit 1
        fi
        # Set up RPM build environment
        export RPM_BUILD_ROOT="${RPM_OUTPUT_PATH}/rpmbuild"
        # Remove any existing build directory to ensure clean state
        rm -rf "${RPM_BUILD_ROOT}"
        mkdir -p "${RPM_BUILD_ROOT}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}

        # Package information
        PACKAGE_NAME="${DRIVER_VENDOR}-kmods"
        PACKAGE_VERSION="${DRIVER_VERSION}"
        PACKAGE_RELEASE="1.$(echo "${KERNEL_VERSION}" | tr '.-' '_')"
        SPEC_FILE="${RPM_BUILD_ROOT}/SPECS/${PACKAGE_NAME}.spec"

        echo "Creating RPM spec file: ${SPEC_FILE}"

        # Create RPM spec file by building it line by line
        {
          echo "Name:           ${PACKAGE_NAME}"
          echo "Version:        ${PACKAGE_VERSION}"
          echo "Release:        ${PACKAGE_RELEASE}"
          echo "Summary:        ${DRIVER_VENDOR} out-of-tree kernel modules for kernel ${KERNEL_VERSION}"
          echo "License:        Proprietary"
          echo "Group:          System Environment/Kernel"
          echo "BuildArch:      x86_64"
          echo "Requires:       kernel = ${KERNEL_VERSION}"
          # Prevent rpmbuild from stripping or modifying already-signed .ko files
          echo "%undefine _debugsource_packages"
          echo "%undefine _debuginfo_subpackages"
          echo "%undefine debug_package"
          echo "%global __brp_strip /bin/true"
          echo "%global __brp_strip_comment_note /bin/true"
          echo "%global __brp_strip_static_archive /bin/true"
          echo "%global __os_install_post %{nil}"
          echo ""
          echo "%description"
          echo "This package contains signed out-of-tree kernel modules for ${DRIVER_VENDOR}"
          echo "driver version ${PACKAGE_VERSION}, built for kernel ${KERNEL_VERSION}."
          echo ""
          echo "%prep"
          echo "# No prep needed"
          echo ""
          echo "%build"
          echo "# No build needed"
          echo ""
          echo "%install"
          echo "mkdir -p %{buildroot}/lib/modules/${KERNEL_VERSION}/extra/${DRIVER_VENDOR}"
          echo "cp %{_sourcedir}/*.ko %{buildroot}/lib/modules/${KERNEL_VERSION}/extra/${DRIVER_VENDOR}/"
          echo ""
          echo "%files"
          echo "/lib/modules/${KERNEL_VERSION}/extra/${DRIVER_VENDOR}/*.ko"
          echo ""
          echo "%post"
          echo "/sbin/depmod -a ${KERNEL_VERSION} || :"
          echo ""
          echo "%postun"
          echo "/sbin/depmod -a ${KERNEL_VERSION} || :"
          echo ""
          echo "%changelog"
          echo "* $(date '+%a %b %d %Y') Konflux CI <konflux-ci@redhat.com> - ${PACKAGE_VERSION}-${PACKAGE_RELEASE}"
          echo "- Automated build of signed ${DRIVER_VENDOR} kernel modules for ${KERNEL_VERSION}"
        } > "${SPEC_FILE}"

        # Ensure SOURCES directory is clean and copy ONLY signed .ko files
        echo "Cleaning SOURCES directory and copying signed .ko files..."
        rm -f "${RPM_BUILD_ROOT}/SOURCES"/*.ko 2>/dev/null || true
        cp "${SIGNED_KMODS_PATH}"/*.ko "${RPM_BUILD_ROOT}/SOURCES/"

        echo "Files now in SOURCES directory:"
        ls -la "${RPM_BUILD_ROOT}/SOURCES"/*.ko

        # Verify checksums in RPM SOURCES directory to ensure integrity
        echo "Verifying .ko files in RPM SOURCES directory..."
        cd "${RPM_BUILD_ROOT}/SOURCES"
        if ! sha256sum -c "${TEMP_WORK_DIR}/signed_kmods_checksums.txt"; then
            echo "ERROR: Checksum verification failed for .ko files in RPM SOURCES"
            echo "Files may have been corrupted during copy operation"
            exit 1
        fi
        echo "RPM SOURCES checksum verification passed"
        cd "${TEMP_WORK_DIR}"

        # Build the RPM
        echo "Building RPM package..."
        rpmbuild --define "_topdir ${RPM_BUILD_ROOT}" \
                 --define "_sourcedir ${RPM_BUILD_ROOT}/SOURCES" \
                 -bb "${SPEC_FILE}"

        # Move built RPMs to output directory
        find "${RPM_BUILD_ROOT}/RPMS" -name "*.rpm" -exec mv {} "${RPM_OUTPUT_PATH}/" \;

        # Verify that .ko files in the built RPM are signed
        echo "Verifying that .ko files in built RPM are signed..."
        RPM_FILE=$(find "${RPM_OUTPUT_PATH}" -name "*.rpm" | head -1)
        if [ -n "${RPM_FILE}" ]; then
            VERIFICATION_DIR="${TEMP_WORK_DIR}/rpm_verification"
            mkdir -p "${VERIFICATION_DIR}"
            cd "${VERIFICATION_DIR}"

            # Extract .ko files from RPM
            rpm2cpio "${RPM_FILE}" | cpio -idm "*/lib/modules/*/*.ko" 2>/dev/null || true

            # Find extracted .ko files and verify they match signed checksums
            if ! find . -name "*.ko" -type f | head -1 >/dev/null; then
                echo "ERROR: No .ko files found in built RPM"
                exit 1
            fi

            echo "Found .ko files in RPM, verifying they are signed..."
            # Check if extracted files match signed checksums
            EXTRACTED_KO_COUNT=$(find . -name "*.ko" -type f | wc -l)
            SIGNED_KO_COUNT=$(find "${SIGNED_KMODS_PATH}" -name "*.ko" -type f | wc -l)

            echo "RPM contains ${EXTRACTED_KO_COUNT} .ko files, expected ${SIGNED_KO_COUNT} signed files"

            if [ "${EXTRACTED_KO_COUNT}" -ne "${SIGNED_KO_COUNT}" ]; then
                echo "ERROR: RPM .ko file count mismatch"
                exit 1
            fi

            echo "SUCCESS: RPM contains the expected number of .ko files"

            # Verify that extracted .ko files match the signed ones by checksum
            echo "Verifying checksums of .ko files extracted from RPM..."
            find . -name "*.ko" -type f | while read -r ko_file; do
                ko_basename=$(basename "${ko_file}")
                if [ ! -f "${SIGNED_KMODS_PATH}/${ko_basename}" ]; then
                    echo "ERROR: ${ko_basename} not found in signed kmods directory"
                    exit 1
                fi

                EXTRACTED_CHECKSUM=$(sha256sum "${ko_file}" | cut -d' ' -f1)
                SIGNED_CHECKSUM=$(sha256sum "${SIGNED_KMODS_PATH}/${ko_basename}" | cut -d' ' -f1)

                if [ "${EXTRACTED_CHECKSUM}" != "${SIGNED_CHECKSUM}" ]; then
                    echo "ERROR: ${ko_basename} checksum mismatch - RPM contains unsigned version!"
                    echo "  Extracted: ${EXTRACTED_CHECKSUM}"
                    echo "  Signed:    ${SIGNED_CHECKSUM}"
                    exit 1
                fi
                echo "SUCCESS: ${ko_basename} checksum matches signed version"
            done
            echo "SUCCESS: All .ko files in RPM match signed versions"

            cd "${TEMP_WORK_DIR}"
            rm -rf "${VERIFICATION_DIR}"
        else
            echo "ERROR: No RPM file found for verification"
            exit 1
        fi

        # Cleanup intermediate files
        rm -rf "${RPM_BUILD_ROOT}"

        # Cleanup temporary working directory
        rm -rf "${TEMP_WORK_DIR}"

        # List built RPMs
        echo "Built RPM packages:"
        ls -la "${RPM_OUTPUT_PATH}"/*.rpm

        echo "RPM build completed successfully"
    - name: create-trusted-artifact
      computeResources:
        limits:
          memory: 128Mi
        requests:
          memory: 128Mi
          cpu: 250m
      ref:
        resolver: "git"
        params:
          - name: url
            value: $(params.taskGitUrl)
          - name: revision
            value: $(params.taskGitRevision)
          - name: pathInRepo
            value: stepactions/create-trusted-artifact/create-trusted-artifact.yaml
      params:
        - name: ociStorage
          value: $(params.ociStorage)
        - name: workDir
          value: $(params.dataDir)
        - name: sourceDataArtifact
          value: $(results.sourceDataArtifact.path)
