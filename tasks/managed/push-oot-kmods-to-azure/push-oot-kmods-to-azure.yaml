---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-oot-kmods-to-azure
spec:
  description: >-
    Task to upload out-of-tree kernel modules to Azure Blob Storage
  params:
    - name: signedKmodsPath
      type: string
      description: Path where the kernel modules are stored relative to the dataDir
    - name: dataDir
      type: string
      description: The absolute path to the working directory
      default: /var/workdir/release
    - name: azureStorageAccount
      type: string
      description: Azure Storage account name
    - name: azureContainer
      type: string
      description: Azure Blob container name
    - name: azureSpSecret
      type: string
      description: Kubernetes Secret with AZURE_TENANT_ID, AZURE_CLIENT_ID, and AZURE_CLIENT_SECRET
    - name: sourceDataArtifact
      type: string
      description: Location of trusted artifacts to be used to populate data directory
      default: ""
    - name: orasOptions
      description: oras options to pass to Trusted Artifacts calls
      type: string
      default: ""
    - name: trustedArtifactsDebug
      description: Flag to enable debug logging in trusted artifacts. Set to a non-empty string to enable
      type: string
      default: ""
    - name: taskGitUrl
      type: string
      description: The git repository URL for task and StepAction resolution
      default: https://github.com/konflux-ci/release-service-catalog.git
    - name: taskGitRevision
      type: string
      description: The git revision for task and StepAction resolution
      default: main
  volumes:
    - name: workdir
      emptyDir: {}
    - name: azure-sp-secret-vol
      secret:
        secretName: $(params.azureSpSecret)
  stepTemplate:
    securityContext:
      runAsUser: 1001
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir
    env:
      - name: "ORAS_OPTIONS"
        value: "$(params.orasOptions)"
      - name: "DEBUG"
        value: "$(params.trustedArtifactsDebug)"
  steps:
    - name: use-trusted-artifact
      computeResources:
        limits:
          memory: 64Mi
        requests:
          memory: 64Mi
          cpu: 30m
      ref:
        resolver: "git"
        params:
          - name: url
            value: $(params.taskGitUrl)
          - name: revision
            value: $(params.taskGitRevision)
          - name: pathInRepo
            value: stepactions/use-trusted-artifact/use-trusted-artifact.yaml
      params:
        - name: workDir
          value: $(params.dataDir)
        - name: sourceDataArtifact
          value: $(params.sourceDataArtifact)
    - name: upload-to-azure
      image: mcr.microsoft.com/azure-cli@sha256:a4cc8fbb908dd2652db6caa4b9053af671d914ddf52aa81a766342603e21b507
      computeResources:
        limits:
          memory: 512Mi
        requests:
          memory: 512Mi
          cpu: 250m
      volumeMounts:
        - name: azure-sp-secret-vol
          mountPath: /var/secrets/azure-sp
          readOnly: true
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail

        set +x # disable logging of the credentials
        AZURE_TENANT_ID=$(cat /var/secrets/azure-sp/AZURE_TENANT_ID)
        export AZURE_TENANT_ID
        AZURE_CLIENT_ID=$(cat /var/secrets/azure-sp/AZURE_CLIENT_ID)
        export AZURE_CLIENT_ID
        AZURE_CLIENT_SECRET=$(cat /var/secrets/azure-sp/AZURE_CLIENT_SECRET)
        export AZURE_CLIENT_SECRET

        SIGNED_KMODS_FULL_PATH="$(params.dataDir)/$(params.signedKmodsPath)"
        ACCOUNT="$(params.azureStorageAccount)"
        CONTAINER="$(params.azureContainer)"

        # Check if this is a multi-architecture build
        if [ -f "$(params.dataDir)/arch_count.txt" ]; then
            arch_count=$(cat "$(params.dataDir)/arch_count.txt")
            echo "Processing $arch_count architecture(s) for Azure upload"
        else
            echo "No architecture information found, assuming single architecture"
            arch_count=1
        fi

        echo "Logging into Azure..."
        az login --service-principal \
          -u "$AZURE_CLIENT_ID" \
          -p "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID" \
          --allow-no-subscriptions
        set -x # enable logging after the credentials are logged in

        echo "Ensuring container '${CONTAINER}' exists..."
        az storage container create \
          --name "$CONTAINER" \
          --account-name "$ACCOUNT" \
          --auth-mode login >/dev/null

        # Function to upload artifacts for a specific architecture
        upload_arch_artifacts() {
            local arch_name="$1"
            local source_dir="$2"

            # Always include architecture suffix for consistent hierarchy
            local arch_suffix="/${arch_name}"

            echo "Processing Azure upload for architecture: $arch_name"

            # Read envfile to get version information
            if [ -f "$source_dir/envfile" ]; then
                # shellcheck source=/dev/null
                . "$source_dir/envfile"
            else
                echo "ERROR: envfile not found in $source_dir"
                return 1
            fi

            AZURE_TARGET_PATH="${DRIVER_VENDOR}/${DRIVER_VERSION}/${KERNEL_VERSION}${arch_suffix}/"
            echo "Azure target path for $arch_name: ${ACCOUNT}/${CONTAINER}/${AZURE_TARGET_PATH}"

            # Upload .ko files
            if ls "$source_dir"/*.ko 1> /dev/null 2>&1; then
                echo "Uploading .ko files for $arch_name"
                for f in "$source_dir"/*.ko; do
                    if [ -f "$f" ]; then
                        BLOB_NAME="${AZURE_TARGET_PATH}$(basename "$f")"
                        echo "Uploading ${f} to ${BLOB_NAME}..."
                        az storage blob upload \
                          --account-name "$ACCOUNT" \
                          --container-name "$CONTAINER" \
                          --name "$BLOB_NAME" \
                          --file "$f" \
                          --auth-mode login \
                          --overwrite
                    fi
                done
            else
                echo "WARNING: No .ko files found for architecture $arch_name"
                return 1
            fi

            # Upload checksum file (always use arch-specific filename)
            if [ -f "$source_dir/signed_kmods_checksums_${arch_name}.txt" ]; then
                echo "Uploading architecture-specific checksums for $arch_name"
                CHECKSUM_BLOB_NAME="${AZURE_TARGET_PATH}signed_kmods_checksums_${arch_name}.txt"
                az storage blob upload \
                  --account-name "$ACCOUNT" \
                  --container-name "$CONTAINER" \
                  --name "$CHECKSUM_BLOB_NAME" \
                  --file "$source_dir/signed_kmods_checksums_${arch_name}.txt" \
                  --auth-mode login \
                  --overwrite
            fi

            # Upload envfile for reference
            if [ -f "$source_dir/envfile" ]; then
                echo "Uploading envfile for $arch_name"
                ENVFILE_BLOB_NAME="${AZURE_TARGET_PATH}envfile"
                az storage blob upload \
                  --account-name "$ACCOUNT" \
                  --container-name "$CONTAINER" \
                  --name "$ENVFILE_BLOB_NAME" \
                  --file "$source_dir/envfile" \
                  --auth-mode login \
                  --overwrite
            fi

            return 0
        }

        # Process architectures
        if [ "$arch_count" -gt 1 ]; then
            echo "Multi-architecture build detected, processing each architecture"

            # Upload summary files first
            if [ -f "${SIGNED_KMODS_FULL_PATH}/signing_summary.txt" ]; then
                # Use first architecture's envfile for base path information
                first_arch_dir=$(find "${SIGNED_KMODS_FULL_PATH}" -mindepth 1 -maxdepth 1 -type d | head -1)
                if [ -n "$first_arch_dir" ] && [ -f "$first_arch_dir/envfile" ]; then
                    # shellcheck source=/dev/null
                    . "$first_arch_dir/envfile"
                    summary_azure_path="${DRIVER_VENDOR}/${DRIVER_VERSION}/${KERNEL_VERSION}/multi-arch-summary/"

                    echo "Uploading multi-architecture summary to Azure: ${ACCOUNT}/${CONTAINER}/${summary_azure_path}"
                    az storage blob upload \
                      --account-name "$ACCOUNT" \
                      --container-name "$CONTAINER" \
                      --name "${summary_azure_path}signing_summary.txt" \
                      --file "${SIGNED_KMODS_FULL_PATH}/signing_summary.txt" \
                      --auth-mode login \
                      --overwrite

                    if [ -f "${SIGNED_KMODS_FULL_PATH}/extraction_summary.txt" ]; then
                        az storage blob upload \
                          --account-name "$ACCOUNT" \
                          --container-name "$CONTAINER" \
                          --name "${summary_azure_path}extraction_summary.txt" \
                          --file "${SIGNED_KMODS_FULL_PATH}/extraction_summary.txt" \
                          --auth-mode login \
                          --overwrite
                    fi
                fi
            fi

            # Process each architecture directory
            for arch_dir in "${SIGNED_KMODS_FULL_PATH}"/*/; do
                if [ -d "$arch_dir" ]; then
                    arch_name=$(basename "$arch_dir")
                    echo "Processing Azure upload for architecture: $arch_name"

                    if upload_arch_artifacts "$arch_name" "$arch_dir"; then
                        echo "Successfully uploaded $arch_name to Azure"
                    else
                        echo "ERROR: Failed to upload $arch_name to Azure"
                        exit 1
                    fi
                fi
            done

        else
            echo "Single architecture build, using standard upload"

            # Get the actual architecture directory name
            arch_dir=$(find "${SIGNED_KMODS_FULL_PATH}" -mindepth 1 -maxdepth 1 -type d | head -1)
            if [ -z "$arch_dir" ]; then
                echo "ERROR: No architecture directory found in ${SIGNED_KMODS_FULL_PATH}"
                exit 1
            fi
            actual_arch=$(basename "$arch_dir")
            echo "Detected architecture: $actual_arch"

            if upload_arch_artifacts "$actual_arch" "$arch_dir"; then
                echo "Successfully uploaded single architecture to Azure: $actual_arch"
            else
                echo "ERROR: Failed to upload single architecture to Azure: $actual_arch"
                exit 1
            fi
        fi

        echo "Azure upload complete for $arch_count architecture(s)."
