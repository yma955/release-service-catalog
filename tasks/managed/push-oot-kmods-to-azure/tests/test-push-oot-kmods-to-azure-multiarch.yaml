---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-push-oot-kmods-to-azure-multiarch
spec:
  description: Simplified test for Azure push task - validates parameter parsing only.
  params:
    - name: dataDir
      type: string
    - name: taskGitUrl
      type: string
      default: https://github.com/enriquebelarte/release-service-catalog.git
    - name: taskGitRevision
      type: string
      default: signed-kmods-release
  tasks:
    - name: setup-and-validate
      taskSpec:
        params:
          - name: dataDir
            type: string
        steps:
          - name: setup-and-validate
            image: quay.io/konflux-ci/release-service-utils@sha256:f10b4ad888634a7633f76ede29003ce1471aec2b76a7d9e01ad282a3011eb78f
            script: |
              #!/usr/bin/env bash
              set -eux

              # Create minimal required structure
              SIGNED_KMODS_PATH="$(params.dataDir)/signed-kmods"
              mkdir -p "$SIGNED_KMODS_PATH"

              # Create test .ko file
              echo "TEST_KMOD_DATA" > "$SIGNED_KMODS_PATH/test.ko"

              # Create envfile with required variables
              cat > "$SIGNED_KMODS_PATH/envfile" << 'EOF'
              DRIVER_VENDOR=test-vendor
              DRIVER_VERSION=1.0.0
              KERNEL_VERSION=6.5.0-test
              EOF

              echo "Test setup completed successfully"

              # Validate required files exist
              [ -f "$SIGNED_KMODS_PATH/test.ko" ] || { echo "ERROR: .ko file missing"; exit 1; }
              [ -f "$SIGNED_KMODS_PATH/envfile" ] || { echo "ERROR: envfile missing"; exit 1; }

              # Validate envfile content by parsing explicitly
              DRIVER_VENDOR=$(grep "^DRIVER_VENDOR=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)
              DRIVER_VERSION=$(grep "^DRIVER_VERSION=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)
              KERNEL_VERSION=$(grep "^KERNEL_VERSION=" "$SIGNED_KMODS_PATH/envfile" | cut -d= -f2)

              [ -n "$DRIVER_VENDOR" ] || { echo "ERROR: DRIVER_VENDOR not set"; exit 1; }
              [ -n "$DRIVER_VERSION" ] || { echo "ERROR: DRIVER_VERSION not set"; exit 1; }
              [ -n "$KERNEL_VERSION" ] || { echo "ERROR: KERNEL_VERSION not set"; exit 1; }

              echo "SUCCESS: All validation checks passed"
              echo "Task would upload to Azure path: $DRIVER_VENDOR/$DRIVER_VERSION/$KERNEL_VERSION/"
      params:
        - name: dataDir
          value: $(params.dataDir)
